<html>
  <head>
    <title>Chicago Crimes PyScript App</title>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="./favicon.png">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config>
packages = [
  "altair"
  "pandas"
]
    </py-config>
  </head>
  <body>
    <div id="info">Loading ...</div>
    <py-script output="info">
import altair as alt
import pandas as pd

from pyodide.http import open_url
from datetime import datetime
from js import console
from js import document

info_element = document.getElementById('info')
info_element.innerText = 'Loading Data ...'
start_time = datetime.now()

# read slimmed down 2022 crimes CSV data
data_url = (
  'https://raw.githubusercontent.com/RandomFractals/chicago-crimes/main/data'
)
crimes_data_url = f'{data_url}/crimes-2022-slim.csv'
crimes = pd.read_csv(open_url(crimes_data_url),
  parse_dates=['Date'],
  cache_dates=True,
  low_memory=False)

# calculate, log, and display data load time
end_time = datetime.now()
load_time = (end_time - start_time).total_seconds()
status = f'Load time: {load_time} seconds'
console.log(status)
info_element.innerText = status
# print(crimes.head(100).to_html())

# get crime counts by primary type
crimes_by_type = crimes.groupby('Primary Type').size().to_frame(name='Total')
crimes_by_type = crimes_by_type.reset_index().sort_values(by=['Total'], ascending=False)
# print(crimes_by_type.to_html())

# create crimes by type bar chart
crimes_by_type_chart = alt.Chart(crimes_by_type[0:20]).mark_bar().encode(
  x={'field': 'Total', 'type': 'quantitative', 'title': 'Reports'},
  y={'field': 'Primary Type', 'type': 'nominal', 'title': 'Crime', 'sort': 'x'},
  tooltip=[
    {'field': 'Primary Type', 'type': 'nominal', 'title': 'Crime Type'},
    {'field': 'Total', 'type': 'quantitative', 'title': 'Reports'}
  ]
).properties(title='Chicago Crime Reports by Type - 2022')

# set Date index for time series plots
crimes.index = crimes['Date']

# get crimes by type
crimes_by_type = crimes[['Primary Type']]

# sum daily crime reports
daily_reports = crimes_by_type.resample('D').count()
daily_reports.columns = ['Reports'] # rename Primary Type column
daily_reports = daily_reports.reset_index()

# plot daily crime reports
daily_reports_chart = alt.Chart(daily_reports).mark_line().encode(
  x='Date:T',
  y='Reports:Q',
  tooltip=['Reports', 'Date']
).properties(title='Dialy Chicago Crime Reports - 2022')

# get arrests
arrests = crimes[crimes['Arrest'] == True]['Arrest']

# sum arrests per day
daily_arrests = arrests.resample('D').sum().to_frame(name='Arrests')
daily_arrests = daily_arrests.reset_index()

# plot daily arrests
daily_arrestss_chart = alt.Chart(daily_arrests).mark_line().encode(
  x='Date:T',
  y='Arrests:Q',
  tooltip=['Arrests', 'Date']
).properties(title='Dialy Chicago Arrests - 2022')

# get domestic crime reports
domestic_reports = crimes[crimes['Domestic'] == True]['Domestic']

# sum domestic crime reports per day
daily_domestic_reports = domestic_reports.resample('D').sum().to_frame(name='Reports')
daily_domestic_reports = daily_domestic_reports.reset_index()

# plot daily domestic crime reports
daily_domestic_reports_chart = alt.Chart(daily_domestic_reports).mark_line().encode(
  x='Date:T',
  y='Reports:Q',
  tooltip=['Reports', 'Date']
).properties(title='Daily Domestic Chicago Crime Reports - 2022')

# combine and show Altair charts
alt.vconcat(
  crimes_by_type_chart,
  daily_reports_chart,
  daily_arrestss_chart,
  daily_domestic_reports_chart
)
    </py-script>
  </body>
</html>
<html>
  <head>
    <title>Chicago Crimes PyScript App</title>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="./favicon.png">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <py-config>
packages = [
  "altair"
  "pandas"
]
    </py-config>
  </head>
  <body>
    <div id="info">Loading ...</div>
    <py-script output="info">
import altair as alt
import pandas as pd

from pyodide.http import open_url
from datetime import datetime
from js import console
from js import document

info_element = document.getElementById('info')
info_element.innerText = 'Loading Data ...'
start_time = datetime.now()

# read slimmed down 2022 crimes CSV data
data_url = (
  'https://raw.githubusercontent.com/RandomFractals/chicago-crimes/main/data'
)
crimes_data_url = f'{data_url}/crimes-2022-slim.csv'
crimes = pd.read_csv(open_url(crimes_data_url),
  parse_dates=['Date'],
  cache_dates=True,
  low_memory=False)

# calculate, log, and display data load time
end_time = datetime.now()
load_time = (end_time - start_time).total_seconds()
status = f'Load time: {load_time} seconds'
console.log(status)
info_element.innerText = status
# print(crimes.head(100).to_html())

# get crime counts by primary type
crimes_by_type = crimes.groupby('Primary Type').size().to_frame(name='Total')
crimes_by_type = crimes_by_type.reset_index().sort_values(by=['Total'], ascending=False)
# print(crimes_by_type.to_html())

# create crimes by type bar chart
alt.Chart(crimes_by_type[0:20]).mark_bar().encode(
  x={'field': 'Total', 'type': 'quantitative', 'title': 'Reports'},
  y={'field': 'Primary Type', 'type': 'nominal', 'title': 'Crime', 'sort': 'x'},
  tooltip=[
    {'field': 'Primary Type', 'type': 'nominal', 'title': 'Crime Type'},
    {'field': 'Total', 'type': 'quantitative', 'title': 'Reports'}
  ]
).properties(title='Chicago Crime Reports by Type - 2022')
    </py-script>
  </body>
</html>